---
title: "Proportions"
format: pdf
editor: visual
---

## 

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(forcats)
library(qtl2)
library(janitor)
```

```{r}
fertility_data <- read.csv("~/Desktop/UCSB/PSTAT100-final/fertility_data.csv")
infant_mortality_biannual_data <- read.csv("~/Desktop/UCSB/PSTAT100-final/infant_mortality_biannual_data.csv")
```

```{r}
fertility_update <- fertility_data %>%
  filter(bmcode %in% c(1, 2, 3)) %>%  
  group_by(state, year) %>%  
  summarise(across(births_age1524:pop_age3544, ~sum(., na.rm = TRUE))) %>%  
  mutate(bmcode =1,
         across(pop_total:pop_age3544, ~./3)) %>% 
  ungroup() 

# population_data <- fertility_data %>% 
#   group_by(state, year) %>% 
#   summarise(across(pop_total:pop_age3544, ~dplyr::first(na.omit(.)))) %>% 
#   ungroup()

fertility_update2 <- fertility_data %>%
  filter(bmcode %in% c(4, 5, 6)) %>%  
  group_by(state, year) %>%  
  summarise(across(births_age1524:pop_age3544, ~sum(., na.rm = TRUE))) %>%  
  mutate(bmcode = 2,
         across(pop_total:pop_age3544, ~./3)) %>% 
  ungroup()

# fertility_update <- fertility_update %>% 
#   left_join(population_data, by =c("state", "year"))

# fertility_update <- fertility_update %>% 
#   mutate(across(pop_total:pop_age3544, ~./3))

# fertility_update2 <- fertility_update2 %>% 
#   left_join(population_data, by =c("state", "year"))

# fertility_update2 <- fertility_update2 %>% 
#   mutate(across(pop_total:pop_age3544, ~./3))

fertility_merged <- bind_rows(fertility_update, fertility_update2)

fertility_merged <- fertility_merged %>% 
  filter(!year == 2024)
  
fertility_merged |>
  summarize(across(births_age1524:births_nonmedicaid, \(x) mean(is.na(x))))

#births_nhblack:births_otherraceeth, deaths_bhblack,deaths_nhwhite,deaths_hisp, deaths_noncon, deaths_neo, deaths_total
infant_mortality_biannual_data |>
  summarize(across(c(births_nhblack:births_otherraceeth, 
                     deaths_nhblack, deaths_nhwhite, deaths_hisp, 
                     deaths_noncon, deaths_neo, deaths_total), 
                   ~ mean(is.na(.))))
```

```{r}
fertility_merged2 <- fertility_merged %>% 
  mutate(prop_births_1524 = births_age1524 / births_total,
         prop_births_2534 = births_age2534 / births_total,
         prop_births_3544 = births_age3544 / births_total,
         prop_births_nohs = births_nohs / births_total,
         prop_births_hs = births_hs / births_total,
         prop_births_somecoll = births_somecoll / births_total,
         prop_births_coll = births_coll / births_total,
         prop_births_married = births_married / births_total,
         prop_births_unmarried = births_unmarried / births_total,
         prop_births_medicaid = births_medicaid / births_total,
         prop_births_nhblack = births_nhblack / births_total,
         prop_births_nhwhite = births_nhwhite / births_total,
         prop_births_hisp = births_hisp / births_total,
         prop_births_otherraceeth = births_otherraceeth / births_total,
         prop_1524 = pop_age1524 / pop_total,
         prop_2534 = pop_age2534 / pop_total,
         prop_3544 = pop_age3544 / pop_total,
         prop_nohs = pop_nohs / pop_total,
         prop_hs = pop_hs / pop_total,
         prop_somecoll = pop_somecoll / pop_total,
         prop_coll = pop_coll / pop_total,
         prop_married = pop_married /pop_total,
         prop_unmarried = pop_unmarried / pop_total,
         prop_medicaid = pop_medicaid / pop_total,
         prop_nblack = pop_nhblack / pop_total,
         prop_nwhite = pop_nhwhite / pop_total,
         prop_hisp = pop_hisp / pop_total,
         prop_otherraceeth = pop_otherraceeth / pop_total
         )
```

```{r}
fertility_eth <- fertility_merged2 %>% 
  pivot_longer(cols = c("prop_births_nhblack", "prop_births_nhwhite", "prop_births_hisp", "prop_births_otherraceeth"), names_to = "ethnicity", values_to = "eth_births")

ggplot(fertility_eth, aes(x = ethnicity, y = eth_births, fill = ethnicity)) +
  geom_bar(stat = "identity", position = "stack") + coord_flip()
```
