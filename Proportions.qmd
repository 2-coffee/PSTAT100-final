---
title: "Proportions"
format: pdf
editor: visual
---

## 

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(forcats)
library(qtl2)
library(janitor)
#A problem we ran into was trying to merge the datasets. I noticed the births columns by ethnicities did not have the same values. 
```

```{r}
fertility_data <- read.csv("~/Desktop/UCSB/PSTAT100-final/fertility_data.csv")
infant_mortality_biannual_data <- read.csv("~/Desktop/UCSB/PSTAT100-final/infant_mortality_biannual_data.csv")
# fertility_data <- read_csv("~/pstat100/final_project/data/fertility_infant_mortality/fertility_data.csv")
# infant_mortality_biannual_data <- read_csv("~/pstat100/final_project/data/fertility_infant_mortality/infant_mortality_biannual_data.csv")
```

```{r}
fertility_update <- fertility_data %>%
  filter(bmcode %in% c(1, 2, 3)) %>%  
  group_by(state, year) %>%  
  summarise(across(births_age1524:pop_age3544, ~sum(., na.rm = TRUE))) %>%  
  mutate(bacode =1,
         across(pop_total:pop_age3544, ~./3)) %>% 
  ungroup() 

# population_data <- fertility_data %>% 
#   group_by(state, year) %>% 
#   summarise(across(pop_total:pop_age3544, ~dplyr::first(na.omit(.)))) %>% 
#   ungroup()

fertility_update2 <- fertility_data %>%
  filter(bmcode %in% c(4, 5, 6)) %>%  
  group_by(state, year) %>%  
  summarise(across(births_age1524:pop_age3544, ~sum(., na.rm = TRUE))) %>%  
  mutate(bacode = 2,
         across(pop_total:pop_age3544, ~./3)) %>% 
  ungroup()

# fertility_update <- fertility_update %>% 
#   left_join(population_data, by =c("state", "year"))

# fertility_update <- fertility_update %>% 
#   mutate(across(pop_total:pop_age3544, ~./3))

# fertility_update2 <- fertility_update2 %>% 
#   left_join(population_data, by =c("state", "year"))

# fertility_update2 <- fertility_update2 %>% 
#   mutate(across(pop_total:pop_age3544, ~./3))

fertility_merged <- bind_rows(fertility_update, fertility_update2)

fertility_merged <- fertility_merged %>% 
  filter(!year == 2024)
  
fertility_merged |>
  summarize(across(births_age1524:births_nonmedicaid, \(x) mean(is.na(x))))

#births_nhblack:births_otherraceeth, deaths_bhblack,deaths_nhwhite,deaths_hisp, deaths_noncon, deaths_neo, deaths_total
infant_mortality_biannual_data |>
  summarize(across(c(births_nhblack:births_otherraceeth, 
                     deaths_nhblack, deaths_nhwhite, deaths_hisp, 
                     deaths_noncon, deaths_neo, deaths_total), 
                   ~ mean(is.na(.))))
```

```{r}
fertility_merged2 <- fertility_merged %>% 
  select(state:bacode) %>% 
  mutate(prop_births_1524 = births_age1524 / births_total,
         prop_births_2534 = births_age2534 / births_total,
         prop_births_3544 = births_age3544 / births_total,
         prop_births_nohs = births_nohs / births_total,
         prop_births_hs = births_hs / births_total,
         prop_births_somecoll = births_somecoll / births_total,
         prop_births_coll = births_coll / births_total,
         prop_births_married = births_married / births_total,
         prop_births_unmarried = births_unmarried / births_total,
         prop_births_medicaid = births_medicaid / births_total,
         prop_births_nhblack = births_nhblack / births_total,
         prop_births_nhwhite = births_nhwhite / births_total,
         prop_births_hisp = births_hisp / births_total,
         prop_births_otherraceeth = births_otherraceeth / births_total,
         # prop_1524 = pop_age1524 / pop_total,
         # prop_2534 = pop_age2534 / pop_total,
         # prop_3544 = pop_age3544 / pop_total,
         # prop_nohs = pop_nohs / pop_total,
         # prop_hs = pop_hs / pop_total,
         # prop_somecoll = pop_somecoll / pop_total,
         # prop_coll = pop_coll / pop_total,
         # prop_married = pop_married /pop_total,
         # prop_unmarried = pop_unmarried / pop_total,
         # prop_medicaid = pop_medicaid / pop_total,
         # prop_nblack = pop_nhblack / pop_total,
         # prop_nwhite = pop_nhwhite / pop_total,
         # prop_hisp = pop_hisp / pop_total,
         # prop_otherraceeth = pop_otherraceeth / pop_total
         fer_rate_1524 = births_age1524 / pop_age1524,
         fer_rate_2534 = births_age2534 / pop_age2534,
         fer_rate_3544 = births_age3544 / pop_age3544,
         fertility_rate_us = 9 * (fer_rate_1524 + fer_rate_2534 + fer_rate_3544)
         )
```

```{r}
# merge and recalculate number of births. 
infant_mort1 <- infant_mortality_biannual_data |>
  rename("infant_births_total"=births_total) |>
  mutate(across(starts_with("births_"), ~ .x/infant_births_total, .names="prop_{.col}")) |>
  select( c(starts_with("deaths_"),starts_with("prop_births"), infant_births_total, state,year,bacode)) |>
  filter(year >=2016) 

infant_mort1 <- infant_mort1 |>
  mutate(across(colnames(infant_mort1), ~ replace_na(.x,0)))

    


fertil_merg_filter <- fertility_merged2 |> select(c(starts_with("prop_births"),births_total, state, year,bacode)) |> select(11:18)
  
prop_only_merge <- infant_mort1 |>
  left_join(fertil_merg_filter, by=join_by(state,year,bacode)) |>
  mutate(
    norm_births_nhblack = (prop_births_nhblack.x + prop_births_nhblack.y)/2,
    norm_births_nhwhite =( prop_births_nhwhite.x + prop_births_nhwhite.y)/2,
    norm_births_hisp = (prop_births_hisp.x + prop_births_hisp.y)/2,
    norm_births_otherraceeth = (prop_births_otherraceeth.x + prop_births_otherraceeth.y)/2,
    norm_total_births = (infant_births_total+births_total)/2
  ) |>
  mutate(across(starts_with("norm_births_"), ~round(.x*norm_total_births,0), .names="{.col}")) |>
  select(-c(starts_with("prop_"))) |>
  mutate(across(starts_with("deaths_"), ~ round(.x/norm_total_births*1000, 2), .names="infantMort_{.col}")) #|>
  #mutate(across(starts_with("norm_births_"), ~ round(.x/norm_total_births*1000, 2), .names#="fertilityRate_{.col}"))

  
fertility_mortality <- fertility_merged2 |>
  left_join(infant_mortality_biannual_data, by = join_by(state,year, bacode)) |>
  select(-c(ends_with(".x"), ends_with(".y"), starts_with("deaths"))) |>
  left_join(prop_only_merge, by=join_by(state,year,bacode))
  



```

```{r}
births_deaths <- fertility_mortality %>% 
  select(state, year, births_age1524:births_nonmedicaid, births_total:norm_total_births, exposed_infdeaths, deaths_nhblack:deaths_total, fertilityRate_norm_births_nhblack:fertilityRate_norm_births_otherraceeth, infantMort_deaths_nhblack:infantMort_deaths_otherraceeth)

population_update <- fertility_mortality %>% 
  select(state, year, pop_nhblack:prop_fer_3544)
```
